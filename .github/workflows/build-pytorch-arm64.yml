name: Build PyTorch Windows ARM64 Wheels

on:
  workflow_dispatch:
    inputs:
      publish_release:
        description: 'Publish Release?'
        required: false
        type: boolean
        default: false
  push:
    tags:
      - 'v*'

jobs:
  build_wheels:
    name: Build for Python ${{ matrix.python }}
    runs-on: windows-11-arm
    strategy:
      fail-fast: false
      matrix:
        python: ["3.11", "3.12", "3.13"]

    steps:
      - name: Enable long paths in Git
        run: git config --system core.longpaths true

      - name: Checkout PyTorch
        uses: actions/checkout@v4
        with:
          repository: pytorch/pytorch
          submodules: recursive

      - name: Set up Python ${{ matrix.python }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python }}
          architecture: arm64
          cache: 'pip'

      - name: Install Build Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install wheel setuptools --upgrade
          pip install numpy pyyaml typing-extensions

      - name: Install sccache
        shell: powershell
        run: |
          Invoke-WebRequest -Uri "https://github.com/mozilla/sccache/releases/download/v0.13.0/sccache-v0.13.0-aarch64-pc-windows-msvc.tar.gz" -OutFile "sccache.tar.gz"
          tar -xzf sccache.tar.gz
          echo "$PWD/sccache-v0.13.0-aarch64-pc-windows-msvc" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Sccache Cache
        uses: actions/cache@v4
        with:
          path: .sccache
          key: ${{ runner.os }}-sccache-${{ matrix.python }}-${{ hashFiles('setup.py') }}
          restore-keys: |
            ${{ runner.os }}-sccache-${{ matrix.python }}-
            ${{ runner.os }}-sccache-

      - name: Configure Sccache
        shell: bash
        run: |
          echo "SCCACHE_DIR=$GITHUB_WORKSPACE/.sccache" >> $GITHUB_ENV
          echo "SCCACHE_CACHE_SIZE=2G" >> $GITHUB_ENV
          echo "CMAKE_C_COMPILER_LAUNCHER=sccache" >> $GITHUB_ENV
          echo "CMAKE_CXX_COMPILER_LAUNCHER=sccache" >> $GITHUB_ENV

      - name: Configure MSVC for ARM64
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: arm64

      - name: Build PyTorch Wheel
        shell: cmd
        env:
          # --- PREVENT ALL X64/INTEL LEAKAGE ---
          USE_CUDA: 0
          USE_CUDNN: 0
          USE_MKLDNN: 0         # Disable Intel-specific math DNN
          USE_MKLDNN_CBLAS: 0
          USE_FBGEMM: 0         # Fails on Windows ARM64
          USE_NNPACK: 0
          
          # --- DISABLE UNSTABLE ARM64 BACKENDS ---
          USE_DISTRIBUTED: 0    # Gloo/Networking causes crashes on ARM64
          USE_TENSORPIPE: 0
          USE_GLOO: 0           # Explicitly kill Gloo
          USE_OPENMP: 0         # Disable OpenMP (Major cause of stack overruns)
          ATEN_THREADING: NATIVE # Use standard C++ threads instead
          
          # --- ARM64 OPTIMIZATIONS ---
          USE_QNNPACK: 1        # Use native ARM path
          USE_PYTORCH_QNNPACK: 1
          BLAS: Eigen           # The most stable math backend for ARM64 MSVC
          
          # --- COMPILER STABILITY ---
          USE_SYSTEM_MSVC_RUNTIME: 1 
          BUILD_TEST: 0
          USE_KLEIDIAI: 0
        run: |
          set CMAKE_GENERATOR=Visual Studio 17 2022
          set CMAKE_GENERATOR_PLATFORM=ARM64
          python -m pip wheel . --wheel-dir dist/ --no-deps

      - name: Smoke Test Wheel
        shell: cmd
        run: |
          FOR %%i IN (dist\*.whl) DO (
            python -m pip install "%%i"
            python -c "import torch; print(f'Verification Successful: Torch version {torch.__version__} is active on ARM64')"
          )

      - name: Upload Wheel Artifact
        uses: actions/upload-artifact@v4
        with:
          name: pytorch-wheel-py${{ matrix.python }}
          path: dist/*.whl

  release:
    needs: build_wheels
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/') || (github.event_name == 'workflow_dispatch' && inputs.publish_release == true)
    steps:
      - name: Download all wheels
        uses: actions/download-artifact@v4
        with:
          path: all-wheels
          merge-multiple: true

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: all-wheels/*.whl
          name: PyTorch Windows ARM64 Release ${{ github.ref_name }}
          body: |
            Native PyTorch wheels for Windows 11 ARM64 (Snapdragon X Elite/Plus).
            
            ### ðŸ›  Build Configuration
            - **Backend:** Eigen + QNNPACK
            - **Compiler:** MSVC 2022 (Native ARM64)
            - **Stability:** MKLDNN and Distributed disabled for ARM64 compatibility.