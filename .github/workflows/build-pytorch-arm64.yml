name: Build PyTorch Windows ARM64 Wheels

on:
  workflow_dispatch:
    inputs:
      publish_release:
        description: 'Publish Release?'
        required: false
        type: boolean
        default: false
  push:
    tags:
      - 'v*'

jobs:
  build_wheels:
    name: Build for Python ${{ matrix.python }}
    runs-on: windows-11-arm
    strategy:
      fail-fast: false
      matrix:
        python: ["3.11", "3.12", "3.13"] # Testing 3.11 first as the most stable baseline

    steps:
      - name: Enable long paths in Git
        run: git config --system core.longpaths true

      - name: Checkout PyTorch
        uses: actions/checkout@v4
        with:
          repository: pytorch/pytorch
          submodules: recursive

      - name: Set up Python ${{ matrix.python }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python }}
          architecture: arm64
          cache: 'pip'

      - name: Install Build Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install wheel setuptools --upgrade
          pip install numpy pyyaml typing-extensions

      - name: Install sccache
        shell: powershell
        run: |
          Invoke-WebRequest -Uri "https://github.com/mozilla/sccache/releases/download/v0.13.0/sccache-v0.13.0-aarch64-pc-windows-msvc.tar.gz" -OutFile "sccache.tar.gz"
          tar -xzf sccache.tar.gz
          echo "$PWD/sccache-v0.13.0-aarch64-pc-windows-msvc" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Sccache Cache
        uses: actions/cache@v4
        with:
          path: .sccache
          key: ${{ runner.os }}-sccache-${{ matrix.python }}-${{ hashFiles('setup.py') }}
          restore-keys: |
            ${{ runner.os }}-sccache-${{ matrix.python }}-

      - name: Configure Sccache
        shell: bash
        run: |
          echo "SCCACHE_DIR=$GITHUB_WORKSPACE/.sccache" >> $GITHUB_ENV
          echo "SCCACHE_CACHE_SIZE=2G" >> $GITHUB_ENV
          echo "CMAKE_C_COMPILER_LAUNCHER=sccache" >> $GITHUB_ENV
          echo "CMAKE_CXX_COMPILER_LAUNCHER=sccache" >> $GITHUB_ENV

      - name: Configure MSVC for ARM64
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: arm64

      - name: Build PyTorch Wheel
        shell: cmd
        env:
          # --- PREVENT ALL EXTERNAL RUNTIME CONFLICTS ---
          USE_OPENMP: 0
          ATEN_THREADING: NATIVE
          BLAS: Eigen
          USE_QNNPACK: 0
          USE_PYTORCH_QNNPACK: 0
          USE_XNNPACK: 0
        
          # --- STRIP POTENTIAL ALIGNMENT FAULTS ---
          USE_MKLDNN: 0
          USE_DISTRIBUTED: 0
          USE_FBGEMM: 0
        
          # --- THE FIX: STATIC CRT & NO SECURITY CHECK FAILURES ---
          # This bundles the C runtime to avoid ucrtbase.dll conflicts
          CAFFE2_USE_MSVC_STATIC_CRT: ON
          # Disable potentially problematic security instrumentation for this ARM build
          USE_CONTROL_FLOW_GUARD: OFF
        
          USE_SYSTEM_MSVC_RUNTIME: 1
          BUILD_TEST: 0
        run: |
          set CMAKE_GENERATOR=Visual Studio 17 2022
          set CMAKE_GENERATOR_PLATFORM=ARM64
          python -m pip wheel . --wheel-dir dist/ --no-deps

      - name: Verbose Smoke Test
        shell: cmd
        run: |
          FOR %%i IN (dist\*.whl) DO python -m pip install "%%i"
          REM Verbose mode shows exactly where the C-init fails
          python -v -c "import torch; print('--- SUCCESSFUL IMPORT ---')" > import_trace.log 2>&1
          type import_trace.log

      - name: Upload Wheel Artifact
        uses: actions/upload-artifact@v4
        with:
          name: pytorch-safe-wheel-py${{ matrix.python }}
          path: dist/*.whl