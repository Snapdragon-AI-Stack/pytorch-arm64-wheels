name: Build PyTorch Windows ARM64 Wheels

on:
  workflow_dispatch:
    inputs:
      publish_release:
        description: 'Publish Release?'
        required: false
        type: boolean
        default: false
  push:
    tags:
      - 'v*'

jobs:
  build_wheels:
    name: Build for Python ${{ matrix.python }}
    runs-on: windows-11-arm
    strategy:
      fail-fast: false
      matrix:
        python: ["3.11", "3.12", "3.13"] # Testing 3.11 first as the most stable baseline

    steps:
      - name: Enable long paths in Git
        run: git config --system core.longpaths true

      - name: Checkout PyTorch
        uses: actions/checkout@v4
        with:
          repository: pytorch/pytorch
          submodules: recursive

      - name: Set up Python ${{ matrix.python }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python }}
          architecture: arm64
          cache: 'pip'

      - name: Install Build Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install wheel setuptools --upgrade
          pip install numpy pyyaml typing-extensions


      - name: Configure MSVC for ARM64
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: arm64

      - name: Build PyTorch Wheel
        shell: cmd
        env:
          # --- RECOMMENDATION 1: NO SCCACHE ---
          # Disabling sccache ensures no corrupted build artifacts are reused.
          CMAKE_C_COMPILER_LAUNCHER: ""
          CMAKE_CXX_COMPILER_LAUNCHER: ""
          
          # --- RECOMMENDATION 2: DISABLE FBGEMM & SIMD ---
          USE_FBGEMM: 0         # Primary cause of ARM64 stack corruption
          USE_QNNPACK: 0
          USE_PYTORCH_QNNPACK: 0
          USE_XNNPACK: 0
          
          # --- HARDENING AGAINST 0xC0000409 ---
          # 1. Use Static CRT to avoid ucrtbase.dll version mismatches
          CAFFE2_USE_MSVC_STATIC_CRT: ON
          # 2. Force standard C++ threads
          USE_OPENMP: 0
          ATEN_THREADING: NATIVE
          # 3. Use the stable Eigen backend
          BLAS: Eigen
          
          # --- COMPILER STABILITY ---
          USE_SYSTEM_MSVC_RUNTIME: 1
          BUILD_TEST: 0
          REL_WITH_DEB_INFO: 1   # Enabled for debugging if it fails again
        run: |
          set CMAKE_GENERATOR=Visual Studio 17 2022
          set CMAKE_GENERATOR_PLATFORM=ARM64
          python -m pip wheel . --wheel-dir dist/ --no-deps

      - name: Verbose Smoke Test
        shell: cmd
        run: |
          FOR %%i IN (dist\*.whl) DO python -m pip install "%%i"
          REM Verbose mode shows exactly where the C-init fails
          python -v -c "import torch; print('--- SUCCESSFUL IMPORT ---')" > import_trace.log 2>&1
          type import_trace.log

      - name: Upload Wheel Artifact
        uses: actions/upload-artifact@v4
        with:
          name: pytorch-safe-wheel-py${{ matrix.python }}
          path: dist/*.whl