name: Build PyTorch Windows ARM64 Wheels

on:
  workflow_dispatch: # Allows manual trigger
    inputs:
      publish_release:
        description: 'Publish Release?'
        required: false
        type: boolean
        default: false
  push:
    tags:
      - 'v*' # Trigger on version tags (e.g., v2.5.1)

jobs:
  build_wheels:
    name: Build for Python ${{ matrix.python }}
    runs-on: windows-11-arm # Native Windows ARM64 runner
    strategy:
      fail-fast: false
      matrix:
        python: ["3.11", "3.12", "3.13"]

    steps:
      - name: Enable long paths in Git
        run: git config --system core.longpaths true

      - name: Checkout PyTorch
        uses: actions/checkout@v4
        with:
          repository: pytorch/pytorch
          submodules: recursive

      - name: Set up Python ${{ matrix.python }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python }}
          architecture: arm64

      - name: Install Build Dependencies
        run: |
          python -m pip install --upgrade pip
          # Explicitly install 'wheel' and 'setuptools' first to ensure bdist_wheel is available
          pip install wheel setuptools --upgrade
          pip install numpy pyyaml typing-extensions

      - name: Configure MSVC for ARM64
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: arm64

      - name: Build PyTorch Wheel
        shell: cmd
        env:
          # Critical ARM64 Build Flags
          USE_CUDA: 0
          USE_CUDNN: 0
          USE_MKLDNN: 0
          USE_NNPACK: 0
          USE_QNNPACK: 1
          USE_PYTORCH_QNNPACK: 1
          USE_DISTRIBUTED: 0
          BUILD_TEST: 0
          # Use Arm Performance Libraries if installed, otherwise defaults to Eigen
          BLAS: Eigen
        run: |
          set CMAKE_GENERATOR=Visual Studio 17 2022
          set CMAKE_GENERATOR_PLATFORM=ARM64
          # Use 'pip wheel' for a more robust build process than calling setup.py directly
          python -m pip wheel . --wheel-dir dist/ --no-deps

      - name: Upload Wheel Artifact
        uses: actions/upload-artifact@v4
        with:
          name: pytorch-wheel-py${{ matrix.python }}
          path: dist/*.whl

  release:
    needs: build_wheels
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/') || (github.event_name == 'workflow_dispatch' && inputs.publish_release == true)
    steps:
      - name: Download all wheels
        uses: actions/download-artifact@v4
        with:
          path: all-wheels
          merge-multiple: true

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: all-wheels/*.whl
          name: PyTorch Windows ARM64 Release ${{ github.ref_name }}
          body: |
            Native PyTorch wheels for Windows 11 ARM64 (Snapdragon X Elite/Plus).
            Compiled with:
            - MSVC 2022
            - No CUDA
            - QNNPACK Enabled
